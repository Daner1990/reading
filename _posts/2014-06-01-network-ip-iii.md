---
layout: post
title: 计算机网络-网络层(三)
categories: 计算机网络
tag: 网络层
---

###8. ICMP

**为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP。ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告。**

ICMP报文有两种：

1. ICMP差错报告报文
2. ICMP询问报文

因为ICMP报文是放在IP数据报的数据中，而IP首部的检验和不检查数据部分，所以ICMP出错的情况，首部检验和是无法检查到的。

对于ICMP差错报告报文，一共有5种类型：

1. 终点不可达：当路由器或主机不能交付数据时，就会向源点发送终点不可达报文
2. 源点抑制：当路由器或主机因为拥塞而丢弃数据时，就会给源点发送源点抑制报文，源点就知道要放慢发送数据的速率
3. 时间超过：首部中有个生产时间，超过的情况，会向源点发送时间超过报文，并丢弃数据报（分片的情况会全部丢弃）
4. 参数问题：首部数据有问题时，就会发送参数问题报文
5. 改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次发送给另外的路由器（可通过更好的路由）

对于ICMP询问报文，一共有2种类型：

1. 回送请求和回答：由主机或路由器向特定的目的主机发出的询问。目的主机必须进行答复。这种询问常用于询问终点是否可达及了解有关状态
2. 时间戳请求和回答：用于同步时间。是从1900年1月1日开始的秒数

###9. ICMP的应用举例

ICMP的一个重要应用就是**分组间检测——ping(Packet InterNet Groper)**，用来测试两个主机之间的连通性。**ping使用了ICMP回送请求与回送回答报文。ping是应用层直接使用网络层ICMP的一个例子。它没有通过运输层的TCP和UDP。**

另一个非常有用的命令是traceroute（UNIX的命令哦），**它用来跟踪一个分组从源点到终点的路径**。在windows下的命令是tracert。原理是酱紫滴：

> Traceroute从源主机向目的主机发送一连串的IP数据报，数据报中封装的是无法交付的UDP用户数据报（提供非法端口号即可）。第一个数据报P1的生存时间TTL是1。当P1到达第一个路由器R1时，R1先收下它，接着把TTL减1。由于TTL=0，R1就会把P1丢弃，然后发送一个ICMP的差错报告报文——时间超过报文。以此类推，当最后一个数据报刚刚到达目的主机时，数据报的TTL是1.这时候**因为数据达到了目的地址，但是终点不可达（端口非法），所以会发送一个终点不可达的ICMP差错报告报文[不是时间超过ICMP差错报告报文]。

这样，源主机就达到了自己的目的，因为它不仅知道了路径中经过的路由器和目的主机的IP，也知道了经过他们的往返时间。注意的是，对于每个TTL值，源主机会发送三次同样的IP数据报。


