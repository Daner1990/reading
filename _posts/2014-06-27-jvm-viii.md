---
layout: post
title: 深入理解Java虚拟机 - 第八章、虚拟机字节码执行引擎
categories: Java
tags: JVM
---

###前言

执行引擎是Java虚拟机最核心的组成部分之一。执行引擎在执行Java代码的时候可能有解释执行（通过解释器执行）和编译执行（通过即时编译器产生的本地代码执行）两种选择，也可能两者兼备，甚至还可能包含几个不同级别的编译器执行引擎。但从Java虚拟机规范中描述的执行引擎概念模型来说，所有的Java虚拟机的执行引擎都是一样的：它的输入是字节码文件，处理过程是字节码解析的等效过程，输出的是执行结果。

本章重点有下面几个小节：

* 运行时栈帧结构
* 方法调用
* 基于栈的字节码解释执行引擎

###一、运行时栈帧结构

首先，栈帧是用于支持虚拟机进行方法调用和方法执行的**数据结构**（还记得不？栈帧是运行时数据区虚拟机栈的栈元素）。也就是说它就是一个类似结构体的东东，用于存放一些诸如

* 局部变量表
* 操作数栈
* 动态连接
* 方法返回地址

还有一些其他的附属信息。**每一个方法从调用开始到执行完毕，就对应着一个栈帧在虚拟机栈里面从入栈到出栈的过程**。

看图说话：

![img](../image/jvm_stack.jpg)

接下来就具体分析一下栈帧中的元素：

####1. 局部变量表

稍微一想，局部变量表当然存储的是方法参数+方法内的变量。而这些数据被存在变量槽（Variable Slot，下称slot）的最小单位中，slot中能存放的类型为：

1. 8种基类类型（bool/byte/char/short/int/long/float/double)
2. reference
3. returnAddress：指向字节码指令的地址

我们看到，Java虚拟机规范并没有规定每个slot的大小。所以不同的虚拟机或者操作系统可以有各自的实现。当然，一个slot可以存放一个32位以内的数据类型，包含了上面3类中除long和double的其他所有类型。而64的long和double则分配两个连续是slot。这里我们可能会想到多线程访问的问题，但是请记得大前提：**Java虚拟机栈是线程私有的，对线程来说是原子性的**。所以这里连续不连续都不会引起安全问题。 

上面说完了局部变量表的东西，那么JVM如何使用它们呢？答案是索引定位。

在方法执行时，虚拟机是通过局部变量表来完成参数值到参数变量列表的传递过程的，如果是非static方法，**局部变量表的第0号索引的slot默认是当前对象实例的引用，也就是this指向的对象。而且slot可以复用，比如函数内变量作用域只在一个循环内，那么后面的变量可以占用这个slot。

关于局部变量还想再说一点，在J《ava编程思想》的笔记里，曾经分三章提到了类的初始化，那么说局部变量是没有初始化的。在局部变量表中找到了答案：）

> 类变量有两次赋初始值的过程，一个是准备阶段，赋予系统初始值（有final的话在编译时会加上ConstantValue属性，那么在准备时就是常量值了）。另外一次是初始化阶段，是程序员指定的值。因此，如果程序员在初始化不指定值的话，准备阶段也会有默认值。但是局部变量就不同了，因为准备阶段是处于方法区，而局部变量表是处于Java虚拟机栈。所以，一个局部变量定义了但是没有初始值是不能使用的。尽管这点由编译器帮你判断，但是知道原理，即使没有编译器，你也能马上定位错误。

####2. 操作数栈

这个和局部变量表类似，操作数栈的每一个元素可以是Java的任意类型，long和double是2个栈容量，其他1个栈容量。

至于操作数栈的工作原理，去看下表达式如何工作的（逆波兰式）。

####3. 动态连接

每个栈帧都包含一个指向运行时常量池中该栈帧所属方法的引用，**持有这个引用是为了支持方法调用过程中的动态连接**。在前面知道，class文件中的常量池有大量的符号引用，字节码中的方法调用指令就以常量池中指向方法的符号引用为参数。这些符号引用一部分会在类加载阶段或者第一次使用的时候转换成直接引用，这种转化称为**静态解析**。另外一部分将在每一次的运行期间转换为直接引用，这部分称为**动态连接**。

####4. 方法返回地址

一个方法执行结束有两种情况

1. 正常结束：
2. 异常结束：异常结束指的是在方法内部无法处理异常（没有匹配的异常处理器），那么方法就会异常退出。一个方法只要是异常退出，是不会给调用者任何返回值的。

无论何种方式的方法退出，都需要返回到方法被调用的位置，用于恢复上下文供程序继续处理。一般来说，方法正常退出时，调用者的PC计数器的值可以作为返回地址，栈帧很可能会保存这个计数器值。而方法异常退出时，返回地址是要通过异常处理器表来确定的，栈帧中一般不会保存这个信息。

方法退出相当于出栈，可能执行的操作有：

* 恢复上层调用方法的局部变量表和操作数栈
* 把返回值（如果有的话）压入调用者栈帧的操作数栈中
* 调整PC计数器指向下一条指令

####5. 附加信息

这部分Java虚拟机规范没有明确规定，具体实现是虚拟机自己的事情。在实际开发中，一般会把动态连接、方法返回地址和其他附加信息全部归为一类，称为栈帧信息。

###二、方法调用



###三、基于栈的字节码解释执行引擎

