---
layout: post
title: Redis设计与实现（二）、内部映射数据结构
categories: redis
tags: redis
---

##前言

上一章我们介绍了redis的内部结构：

* 双端链表
* 字典
* 跳跃表

但是，创建这些完整的数据结构是比较耗费内存的，如果对于一个特别简单的元素，使用这些数据结构无异于大材小用。为了解决这个问题，redis在条件允许的情况下，会使用内存映射数据结构来代替内部数据结构。

当然了，这些结构有**节省内存**的优点，也有**操作复杂，占用的CPU时间会更多**的缺点，这个要掌握一个平衡，才能使redis的总体效率更好。目前，redis使用两种内存英社数据结构。

###1. 整数集合

整数集合用于**有序、无重复的保存多个整数值，它会根据元素的值，自动选择该用什么长度的整数类型来保存元素**。比如，在一个int set中，最大的元素可以用int16_t保存，那么这个int set的所有元素都是int16_t，当插入一个元素是int32_t的时候，int set会先将所有元素升级为int32_t，再插入这个元素。总的来说，整数集合会自动升级。

看名字我们就知道它的用途：

1. 只保存整数元素
2. 元素的数量不多[因为它不费内存，费CPU。量多的话，肯定是CPU为第一考虑]

所以，添加元素到intset有下面几个步骤：

1. 判断插入元素是否存在于集合，如果存在，没有任何操作(无重复元素)
2. 看元素的长度是否需要把intset升级，如果需要，先升级
3. 插入元素，而且要保证在contents数组中，从小到大排序
4. 维护length

简单总结一下整数集合的特点：

1. 保存**有序、无重复的整数元素**
2. 根据元素的值自动选择对应的类型，但是int set**只升级、不降级**
3. 升级会引起整个int set中的contents数组重新内存分配，并移动所有的元素（因为内存不一样了），所以复杂度为O(N)
4. 因为int set是有序的，所以查找使用的是binary search

###2. 压缩列表


